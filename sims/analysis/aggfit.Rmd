---
title: "Aggregate error measurments for estimates of likelihood curves"
output: html_document
toc: true
theme: cerulean
---

## Recent changes
* distinguish between failing and successful lcfit estimation.
* Zoom in to the area of highest interest.  Full plot is inset.
  

```{r echo=FALSE, results='hide'}
library(ggplot2)
library(grid)
library(plyr)
library(reshape2)
library(RJSONIO)
source("utils.R")

theme_set(theme_bw(16))

source("aggutils.R")

DEFAULT_MODEL=c(c=1500, m=1000,r=2.0,b=0.5)


```


```{r echo=FALSE, results='hide'}

setwd("..")

aggdata <- read.csv("aggfit.csv", stringsAsFactors=F)

m <- melt(aggdata, id=c("tree", "node_id"))
# it seems there is no easy way to avoid having melt convert your character columns to factors.
# convert them back to characters
m$tree <- as.character(m$tree)
m <- cbind(m, colsplit(m$variable, names = c("measure", "fitting", "nextra"), pattern="_"))
m <- m[!is.na(m$value),]

```

## LCFIT techniques


We fit the LCFIT function using variable number of extra points and 
a variety of fitting techniques.   For each fitting
technique shown below we try to estimate the likelihood curve with
lcfit using an increasing number of extra points.   We score each
attempt by calculating the weighted and unweighted residual error between the lcfit curve and the actual likelihood
as calculated by BPP.

* unweighted lcfit - the standard lcfit procedure.
* weighted lcfit - the squared difference objective function is weighted by
  likelihood of the point being measured.
* top4 lcfit - an unweighted objective function, but fit to  only the top four
  highest-likelihood points regardless of how many extra points were used.

##LCFIT failures

LCFIT may fail in a variety of ways.

* The objective function may not converge to within our tolerance values
  in the specified number of iterations (default: 500)
* The objective function may not move towards convergence at all, in
  which case the nonlinear estimator will exit before reaching the
  maximum iterations.

If the fitting procedure does not converge or otherwise encounters an
error, the error measures are negated so the failing cases can be
easily identified.

Out of `r nrow(m)` total attempts, across all fitting procedures and
0-4 extra points for all nodes in every simulated tree, LCFIT fitting
failed `r sum(m$value < 0)` times (`r sprintf("%.2f%%", (sum(m$value<0)/nrow(m))*100)`)

## What does LCFIT look like when it fails?

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" & m$fitting == 'unweighted' & m$value < 0,]
tmp <- tmp[order(tmp$value, decreasing=F),]

setwd("..")
plots <- with(tmp[1, ],
              list(showplot((tree), node_id, nextra,model=DEFAULT_MODEL),
                   showplot((tree), node_id, nextra,model=DEFAULT_MODEL, zoom=T)))
multiplot(plotlist=plots, cols=2)
plots <- with(tmp[2, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)
plots <- with(tmp[3, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```

## Weighted RSS of unweighted LCFIT including failures


This first graph shows the error estimates for only the UNWEIGHTED, or
standard, lcfit function.  All of the error estimates are included,
but those for whic the lcfit function failed in some way are negated.

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" & m$fitting == 'unweighted' ,]
tmp <- tmp[order(tmp$value, decreasing=T),]

p1 <- ggplot() +
      geom_boxplot(aes(x=factor(nextra), value), data=tmp) +
      xlab("number of extra points") +
      ggtitle("unweighted objective function \n including lcfit failures (negative values)") +
      theme(legend.position='bottom')
print(p1)

```

### Weighted RSS of unweighted LCFIT excluding failures

In "Unweighted LCFIT", all sample points have equal weight, hence they
are "unweighted".  The "Weighted RSS" is calculate between the LCFIT curve and
actual BPP curve weighted by actual likelihood.  We exclude all LCFIT failures for this graph

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" & m$fitting == 'unweighted' & m$value >= 0,]
tmp <- tmp[order(tmp$value, decreasing=T),]

p1 <- ggplot() +
      geom_boxplot(aes(x=factor(nextra), value), data=tmp) +
      xlab("number of extra points") +
      ggtitle("unweighted objective function \n excluding lcfit failures") +
      theme(legend.position='bottom')
print(p1)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, warning=F}
setwd("..")
plots <- with(tmp[1, ],
              list(showplot((tree), node_id, nextra,model=DEFAULT_MODEL),
                   showplot((tree), node_id, nextra,model=DEFAULT_MODEL, zoom=T)))
multiplot(plotlist=plots, cols=2)
plots <- with(tmp[2, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)
plots <- with(tmp[3, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```

### Weighted RSS of Weighted LCFIT, excluding failures

"Weighted LCFIT" uses likelihoods to weight the objective function at
each sample point.  The "Weighted RSS" is calculate between the LCFIT curve and
actual BPP curve weighted by actual likelihood.  We exclude all LCFIT failures for this graph

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" & m$fitting == 'weighted' & m$value >= 0,]
tmp <- tmp[order(tmp$value, decreasing=T),]

p1 <- ggplot() +
      geom_boxplot(aes(x=factor(nextra), value), data=tmp) +
      xlab("number of extra points") +
      ggtitle("weighted objective function \n excluding lcfit failures") +
      theme(legend.position='bottom')
print(p1)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[1, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)
plots <- with(tmp[2, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)
plots <- with(tmp[3, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```







```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" & m$fitting == 'weighted' & m$nextra > 2 & m$value != 0,]

p1 <- ggplot() +
      geom_boxplot(aes(x=factor(nextra), value), data=tmp) +
      xlab("number of extra points") +
      ggtitle("weighted rss error for 2 or more extra points\nbetween weighted lcfit and empirical likelihoods") +
      theme(legend.position='bottom')
print(p1)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" & m$fitting == 'unweighted' & m$nextra == 0,]
tmp <- tmp[order(tmp$value, decreasing=T),]

p1 <- ggplot() +
      geom_boxplot(aes(x=factor(nextra), value), data=tmp) +
      xlab("number of extra points") +
      ggtitle("weighted rss error without extra points\nbetween unweighted lcfit and empirical likelihoods") +
      theme(legend.position='bottom')
print(p1)
```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[1, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[2, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[3, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)


```



```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" & m$fitting == 'weighted' & m$nextra == 4,]
tmp <- tmp[order(tmp$value, decreasing=T),]

p1 <- ggplot() +
      geom_boxplot(aes(x=factor(nextra), value), data=tmp) +
      xlab("number of extra points") +
      ggtitle("weighted rss error for 4 extra points\nbetween weighted lcfit and empirical likelihoods") +
      theme(legend.position='bottom')
print(p1)
```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[1, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[2, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[3, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)


```


```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" &  m$nextra == 2,]
tmp <- tmp[order(tmp$value, decreasing=T),]

p1 <- ggplot() +
      geom_boxplot(aes(x=factor(fitting), value), data=tmp) +
      xlab("minimization function") +
      ggtitle("weighted rss error for 2 extra points\n fitting function compared against empirical likelihoods") +
      theme(legend.position='bottom')
print(p1)
```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[1, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```
```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}

tmp <- m[m$measure=="wrss" &  m$nextra == 3,]
tmp <- tmp[order(tmp$value, decreasing=T),]

p1 <- ggplot() +
      geom_boxplot(aes(x=factor(fitting), value), data=tmp) +
      xlab("minimization function") +
      ggtitle("weighted rss error for 3 extra points\n fitting function compared against empirical likelihoods") +
      theme(legend.position='bottom')
print(p1)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[1, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[2, ],
              list(showplot((tree), node_id, model=DEFAULT_MODEL, nextra),
                   showplot((tree), node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)

```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE, results='hide', warning=F}
setwd("..")
plots <- with(tmp[3, ],
              list(showplot(tree, node_id, model=DEFAULT_MODEL, nextra),
                   showplot(tree, node_id, nextra, model=DEFAULT_MODEL,zoom=T)))
multiplot(plotlist=plots, cols=2)


```

```{r eval=TRUE, fig.width=12, fig.height=5, echo=FALSE}

print(tmp[1:3,])

```


# Misc
```{r}
getwd()
as.POSIXlt(Sys.time())
```
